/********************************************************************
Copyright (c) 2017, Check Point Software Technologies Ltd.
All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
********************************************************************/

using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using CheckPointObjects;
using CommonUtils;
using Newtonsoft.Json;

namespace MigrationBase
{
    /// <summary>
    /// Base class for converting objects from a vendor's configuration into Check Point objects repository.
    /// Generates Check Point Management API command line scripts for converted objects and policy packages migration.
    /// </summary>
    public abstract class VendorConverter
    {
        #region Constants

        protected const string AllInternalNetwotkGroupName = "all_internal";
        protected const string AutoGeneratedNameWithError = "_Err_";
        protected const string InvalidServiceNamePrefix = "service_";
        protected const string GlobalRulesSubpolicyName = "Global Rules";

        protected const string HtmlErrorImageTagFormat = "<img style='width:12px;height:12px;margin-left:2px;' title='{0}' src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAACWElEQVR4nLWSzUtUYRSHn3fu3HvnzlxnxjGHFC0nXTioLQoNXLgSM4xqTAjaJEEtCly16B+ICtq5CltEuFVatGlRiyioIAvTMkMYCZ0cTcmx+brvvW+LQsnUVp3lc37nOXA48D9r5sSZK1N9/df3ymi7NWZ7Tt2IdSRvhaJW93m7xrg7N/N0p5zYCc51nz4Samt4E6sBX3aFxWXB0teNo+2PH05sz/q2g3RvytQqgqORxkpkpI5ysoN4lQ+hMfqqN2X+U8BGoS+arE1qAQPr8jWsi0No9QlqK0gWHdm3pyDTm7Kt5oYxK6qQBXeTO5pJ1T6baJU99iJ1zt5V4DnecKi9EZnPg9/Y5O7qMnJxgQOWIpddGd5RkDnen7A7Dw9q7nfkzEe89OyWeD5NcfItwc/vqfg0NfhA2Im/BKJQHPX7v+E8e4K7MI9y5daaoAWmiaMZtNRV4wvq9/8QZPTqs0bc18n6AkozEZEoKp/fnFe5NYRuUJIutqHRWhnuumeF++H3H2QPJpdCV7vi7uQHlN8Ex8PLfIFoLQKQ0xNo+5tQJRdVcglLwXh6Yf1cbi2iLfliQ8FLPQNqPQtSgQJvdQWtuY3wyDiBgQs4716j5tOgB0AqdA9s4TcPFcoln3EseccX11GrP0ABHlAuI6wKhN8A3Y8IRVDlMkqAUpCTkoQVoMmybvoVQhe2jlZlgQfKkeiBOrzpl5RHbiPsMDx/hF3fgCooMEEgEGWBJ9SvGyy3tCoVMzeU4yJdhafAKRVx0mk8XLx4LUozcaSLKz2U67GUL9on17LiJ2VA7hlrmrnUAAAAAElFTkSuQmCC'/>";
        protected const string HtmlAlertImageTagFormat = "<img style='width:14px;height:14px;vertical-align:top;margin-left:2px;' title='{0}' src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAxlBMVEUAAAAuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEAAAD2nHdHAAAAQHRSTlMABwggleHkmSRl+PlqYe7tchv1xskijp6ak9fEwt376uf8A/MeHfoC0eLj2YPrEBGJEw7sGE7+VUzvUn/LzYIUAaow6gAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxIAAAsSAdLdfvwAAACbSURBVBjTbU/XEoJADFywN+y9IGJXsBes/P9XmQ3jjA/uQ7Zc7pIDFIaJH8TiiTBMptJfn8mGilw+8gUaq8haoi9XRFUNs8aeugQNHjWBFrktQYeiC/TIfQkGFDYwJDsjwNUJ44nSdAbMVS2WSiu5sqbw/I3O3Uqws/jG3j8IuUcucnLY4kk5X6JVr0G0enD7fsa/P2zv+XrjLz5CLiCq6N/XOAAAAABJRU5ErkJggg=='/>";
        protected const string HtmlAlertImageTag = "<img style='vertical-align:top;' src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAxlBMVEUAAAAuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEuXJEAAAD2nHdHAAAAQHRSTlMABwggleHkmSRl+PlqYe7tchv1xskijp6ak9fEwt376uf8A/MeHfoC0eLj2YPrEBGJEw7sGE7+VUzvUn/LzYIUAaow6gAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxIAAAsSAdLdfvwAAACbSURBVBjTbU/XEoJADFywN+y9IGJXsBes/P9XmQ3jjA/uQ7Zc7pIDFIaJH8TiiTBMptJfn8mGilw+8gUaq8haoi9XRFUNs8aeugQNHjWBFrktQYeiC/TIfQkGFDYwJDsjwNUJ44nSdAbMVS2WSiu5sqbw/I3O3Uqws/jG3j8IuUcucnLY4kk5X6JVr0G0enD7fsa/P2zv+XrjLz5CLiCq6N/XOAAAAABJRU5ErkJggg=='/>";
        protected const string HtmlDisabledImageTag = "<img style='width:14px;height:14px;vertical-align:top;margin-left:2px;' title='Disabled' src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAA7VBMVEUAAACCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoIAAAChPON7AAAATXRSTlMABwggleHkmSRl+P75amG5OQYFNqZyG/XYGWwijrvPqpPXRhM93fsVzgv8A/MXDvoC0U/Zg8MBwonukBhOx1UfHlLGTO8Qf8vq682CFPaq09YAAAABYktHRACIBR1IAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAApElEQVQY022PxxaCUAxEYy9g771gRVTsHUWxO///Oz7gcY4LZzGZuZskRJZcbvqRx+sD/IGg00NhAAIgRuweBWLxRDKVBjJmz+aAfMFMRYglNsqoVDmpoc68gabESQtt5h10SepZpA95QKRgSJyMMFaJJpgSJ03MWJxjseRkhbWZNtiqNoGyM5ftZRy040k/Q9DsUy8GLBm688z1dn88X+8P/dUXiXocfZ5dd1wAAAAASUVORK5CYII='/>";
        protected const string HtmlRightArrowImageSourceData = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuMTczbp9jAAAAVUlEQVQ4T6XMUQoAIQwDUe9/6dp+BARHa3DhsTDSjIj4gtGB0YHRgVHyyx+/CUapgW4Eo2jgNoJR1oHTyBZW3XHBKN1xwSjdccHowOjA6MDowPguxgT2st0/CFiCmQAAAABJRU5ErkJggg==";
        protected const string HtmlDownArrowImageSourceData = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuMTczbp9jAAAAIUlEQVQ4T2MYBcMZ/MeDiQYUaYYBijTDAEWaRwFBwMAAAKkQD/FskAhtAAAAAElFTkSuQmCC";
        protected const string HtmlSubPolicyArrowImageTagFormat = "<img id='{0}' style='width:16px;height:16px;vertical-align:middle;' src='{1}'/>";
        protected const string HtmlToolLogoImageSource = "src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAgCAYAAACcuBHKAAAACXBIWXMAAAsSAAALEgHS3X78AAABkElEQVRYw+2XvXGDQBCFv/MoNx2YbEPRgZhRA+rA6sC4A7kD1IFUgdUAY9wBhJvJHeAKcMDJw2AQf5JwoBcecLx7b/exmDzPmRoP/APcSVyHRGR8IrMjMs7USjwDMZFxp7ZjDiRExp+6Jh6BDyITtN1oWnOi8HcFdJHXtXZUsQcClnnWn0RkNkBgTzUWKbBimR+rF2ZnCOwaTnVxzBoIBDUEUiABjrexIzJZyYJvK2PcKSfgo7L6yjIP+ylRbFSugW4E/qIz+fYWHUYgBbzTs6q6UlXvljmxB/xTF6jqGngH4iYidYWZ2JPM7Ya/UNUQyERkc0a1qnLrUnit7P4tShQV7NuCWtuXO6oaAy8DlHGGtWhBJLQEPOAAPPV9u6q6VtGyyv1qwvoZjyBwqCzHvWLb+l8n/2fTZqXAcoFFZX0rIkEnEqrq2BMsLtgxqYjctEWpUcAb9CkfYccJGXAQkeOoecIWZliJ8bfGnLjGoCsiO5sZX5NO2yKSAJ61YbqRX0QyEfGB7TVImPu/6J1EBT9qv6X93O05TAAAAABJRU5ErkJggg=='";
        protected const string HtmlCPLogoImageSource = "src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHYAAAAUCAYAAABYm8lAAAAACXBIWXMAAAsSAAALEgHS3X78AAAHwklEQVRo3u1aaWwUZRh+tpwC7Q5Xg1KWxRhDgaYrECoe7DSgQcGw1ggKMSxREtBEy79CSLokGggkspKYEmLS5Sj+IWSbICEQZIoVoQJOQUCOyDKAIJI6WxoRsLv+6Ptt3375Zo/W/WH0TSY7813z3tes67dP6gwAfuQHKketWWFIY14AIQBLpfFGGjfpOUhXNRvLF/gAhAFE6MoWjAxzYQB2jueZRHNvQBPv659uVfsDFy786ko9Fw0GSosTPdacsAoAABWeRLYMNAC4AVwDECVEAgAWANDpMkkB/IRsvkGjdxk57hMG0SSdVU5zAaI51/OQozL4AQynewNAtaNgb8RdWLK3EO+8OwmaeyDs+EOcPduGs4fbYFkdcLsHoqxsBCyrA5bVgYa3H2YSrsaEuoq0WUCIrloSthf/LtAVXskgAQdz8AKVOVq4DLYwBEfBbmnuD9+MMaipcVa4DetNLF7yFOrqzuP8xTOZBBskoTZKQuXCDRAzZEZxzY8pGOWl8wVEaJ28JsA8QCwLhgdpn0kKly3EiMbNkpLKFizjqdOzybxXiOHB8fZK49U8lDgKdu+P/VDz2ggAwO6GK7CsDtSs7ilka/8xxOd74HYPxL0/MxIbYAJMt8bLCAMxqFzBcJ3d10vztQCWMcGp1ghm6A64RCgPaHVQxFxdfVThamU8a8mtRwivWvr1K0JalOah2IsCFRYX7nQNa+6BAICxo77H48O2YXfDFTRv2ottn57EvHkHcOfM1R6uO8v4YWbQdENyR+VEvAvABIrNfiJOJ4G10pyL3FmchKGRogjBiHOGExPKHRIVLlS9F+7Ry86N0b3fAc/6NMolhFhJe56hPR8RHyvpTOHGU7QoBdtO1ldW1mWx350uReWCjbhy7DJ27riMc+d+x6JXirFo5Uz8dHxVtoLtLXzGNJq7T40REmAuzaBxN1lqgO7Xsb02zTUpkjMh1MYchGqwKwbgKoDxxPQIw1NX4AkpjKi8isGMIiIloraUUcPRFY91J7uj8Y02nDr+S9fDoYMYrc/Gc7O2Ysqs7fB4pmLypE4sXNiJlusF+RJsNIM2QxErNWleVZrEmKXojIlutr43iUyMeZ4w4eAmJbIVtNVnSBZjigQpIyilUcIEG6o5huVvlaBmtQ+jq5dj6tzJ2LX/A3g8wwAA586/iTlzxmbzrlYFs2UIA0jmUMeNT5MdCkbmkmGL5E7kAtnu1RVXiGepafDMCzgmT6XFSdy69QceFGqoeHUiAGDl+5MAAFVVE3omUVZHtvWWiGnBDAmWwe7TQRPFLl1hsT4pvmlpGgJR1iQJsNIrkiH+ZQMmi7uqWJwXcPSfFZ4EIpFLqKt7AW5KonrE4faH+Lb5NlavbkFNTUs27xIJzFIHwYbIApty6DQZzIXKcekICclMs0YWuMlwaaX56j7y2KazxivoDmcRbnLpnmW22OD0v7Cl+SZemtaAQWNG9phrbr6dsuonipKYPS4Jv56x8xSjrLSeriATjEjp4zkyMkzrNzML9ZLyxMnibCZEkeDwNU4uNwjgB5qPKmJdLiAUrZ4lUDrLlCN9VByh5KlEzVGwJe4kNs57hBNWJ05Y93HprgsPhxThmtVBmTdw4Y4LF+64UnXv2gMDsHb2I7xR1ok0taFNzPJL9VlTL/rCNjEoLPWexVk2Uxyxxs9ifpApg8qFrvuHXLJB5YiMZyPh0JdYGyb8y7nVuuSPADfiLhy63A+HLhWg5XoBViw5iC/3zcfrVV6MGTMEG9Z38X3X5i1Ys2kxAGDFkoOp+6opndg471GqRab4CCDHQcHEvCUS/0XoEWM/PjwA+tZBMB97ErcSCcycdgvX4++hpGRolwv+5nZq7ec756Jw6H18uGw/mk9OzKVRwa3N6ENZ8T9kkxW3P3AhcrJfaqKwcACGFI6CxzMM06cOwI2LO2BZc7rbQaUxFI+M4+tjU7D/yNTUeNHgjK01jcUrHz2bUgLQCaAf29cGwGKJjihjYqwF6aXLlp55bcnHbKnmNVmnymD4mAxvTXqOKWjg9AmvZEs02rRGY++XcfVJYcnLcPZJvBkh1+opwd5kljbO/QVeDK7FqdN38dU+i8qZZ1FafA8zxnXVuKePdgt5xrgEStxJlLiTeOnpRLqsLcQ6RgGKX60swQgRch0AhtH8OvIsPzMmRhmDxJmiIa5JJUaMdYR44zwiJXBtAI6ysBCk+KWz9qXOvIzOerStUu85JGXZ49H1RUuj9Y2s1NIVuIaYgvDulMESL8EbTQprvh6CLS1OYGxREjfbXWjY8zIqWo5jUnEC659PoLQqiaJByb56B5tZl0holpGQTEkL9xABtUSkjwj0sr1RdH8cDyo8g52mPNIV+0YwpnmZ9YYY00WtbWdBg84YHWDvWobuL01mmk6T5lAGxVidHWJZu620WABoWvkgn25fYy22ICPeJI3ugPojABjT+L8rIkxTfVKvlLs/M0OpYkjuzovuT2CCWT7mMoOsXaiigYcLoRw6exbr/QoaTeq8iaZJlJVx2TRCYhnr2DyAyayumrnDpQC2A7gCoATO/2LgQtdYB8tgcY8nY2FWSkTS1Ioh5kZNhqcpWYHO6AizvVGJhrVMeFGqhePME4jS6Zqibha4CqusloQaZnW5U6PDABD6G0N6q38NHi2bAAAAAElFTkSuQmCC'";
        protected const int publishLatency = 100;
        protected const int groupsMaxBulkSize = 100;
        protected const int SubPoliciesMaxNumber = 249;

        #endregion

        #region Members

        protected string _vendorFileName;
        protected string _vendorFilePath;
        protected string _toolVersion;
        protected string _targetFolder;
        protected string _domainName;
        protected string _policyPackageName;
        protected string _policyPackageOptimizedName;
        protected bool _hasNATConversionIncident = false;

        protected CheckPointObjectsRepository _cpObjects = new CheckPointObjectsRepository();

        protected CheckPoint_SimpleGateway _cpSimpleGateway = null;
        protected List<CheckPoint_Domain> _cpDomains = new List<CheckPoint_Domain>();
        protected List<CheckPoint_Host> _cpHosts = new List<CheckPoint_Host>();
        protected List<CheckPoint_Network> _cpNetworks = new List<CheckPoint_Network>();
        protected List<CheckPoint_Range> _cpRanges = new List<CheckPoint_Range>();
        protected List<CheckPoint_NetworkGroup> _cpNetworkGroups = new List<CheckPoint_NetworkGroup>();
        protected List<CheckPoint_GroupWithExclusion> _cpGroupsWithExclusion = new List<CheckPoint_GroupWithExclusion>();
        protected List<CheckPoint_Zone> _cpZones = new List<CheckPoint_Zone>();
        protected List<CheckPoint_TcpService> _cpTcpServices = new List<CheckPoint_TcpService>();
        protected List<CheckPoint_UdpService> _cpUdpServices = new List<CheckPoint_UdpService>();
        protected List<CheckPoint_SctpService> _cpSctpServices = new List<CheckPoint_SctpService>();
        protected List<CheckPoint_IcmpService> _cpIcmpServices = new List<CheckPoint_IcmpService>();
        protected List<CheckPoint_RpcService> _cpRpcServices = new List<CheckPoint_RpcService>();
        protected List<CheckPoint_DceRpcService> _cpDceRpcServices = new List<CheckPoint_DceRpcService>();
        protected List<CheckPoint_OtherService> _cpOtherServices = new List<CheckPoint_OtherService>();
        protected List<CheckPoint_ServiceGroup> _cpServiceGroups = new List<CheckPoint_ServiceGroup>();
        protected List<CheckPoint_ApplicationGroup> _cpApplicationGroups = new List<CheckPoint_ApplicationGroup>();
        protected List<CheckPoint_Time> _cpTimes = new List<CheckPoint_Time>();
        protected List<CheckPoint_TimeGroup> _cpTimeGroups = new List<CheckPoint_TimeGroup>();
        protected List<CheckPoint_AccessRole> _cpAccessRoles = new List<CheckPoint_AccessRole>();
        protected List<CheckPoint_Package> _cpPackages = new List<CheckPoint_Package>();
        protected List<CheckPoint_NAT_Rule> _cpNatRules = new List<CheckPoint_NAT_Rule>();

        protected List<ConversionIncident> _conversionIncidents = new List<ConversionIncident>();
        protected Dictionary<int, List<ConversionIncident>> _conversionIncidentsByLineNumber = null;   // must be generated at the end of Convert() method!!!

        protected string LDAP_Account_Unit = null;

        #endregion

        #region Properties

        public string ObjectsScriptFile { get; set; }
        public string ObjectsHtmlFile { get; set; }
        public string PolicyScriptFile { get; set; }
        public string PolicyHtmlFile { get; set; }
        public string PolicyOptimizedScriptFile { get; set; }
        public string PolicyOptimizedHtmlFile { get; set; }
        public string NatHtmlFile { get; set; }
        public string VendorHtmlFile { get; set; }
        public string WarningsHtmlFile { get; set; }
        public string ErrorsHtmlFile { get; set; }
        public int ConversionIncidentCategoriesCount { get; set; }
        public int ConversionIncidentsCommandsCount { get; set; }

        #endregion

        #region Events

        public event Action<int, string> ConversionProgress;

        protected void RaiseConversionProgress(int progress, string title)
        {
            if (ConversionProgress != null)
            {
                ConversionProgress(progress, title);
            }
        }

        #endregion

        #region Methods

        public virtual void Initialize(VendorParser vendorParser, string vendorFilePath, string toolVersion, string targetFolder, string domainName)
        {
            _vendorFilePath = vendorFilePath;
            _toolVersion = toolVersion;
            _targetFolder = targetFolder;
            _domainName = domainName;

            _vendorFileName = Path.GetFileNameWithoutExtension(vendorFilePath);
            _vendorFileName = !string.IsNullOrEmpty(_vendorFileName) ? Regex.Replace(_vendorFileName, @"\s+", "_") : "";

            // policy package names
            _policyPackageName = _vendorFileName + "_policy";
            _policyPackageOptimizedName = _vendorFileName + "_policy_opt";

            // script files
            ObjectsScriptFile = _targetFolder + "\\" + _vendorFileName + "_objects.sh";
            PolicyScriptFile = _targetFolder + "\\" + _policyPackageName + ".sh";
            PolicyOptimizedScriptFile = _targetFolder + "\\" + _policyPackageOptimizedName + ".sh";

            // HTML files
            VendorHtmlFile = _targetFolder + "\\" + _vendorFileName + ".html";
            WarningsHtmlFile = _targetFolder + "\\" + _vendorFileName + "_warnings.html";
            ErrorsHtmlFile = _targetFolder + "\\" + _vendorFileName + "_errors.html";
            ObjectsHtmlFile = _targetFolder + "\\" + _vendorFileName + "_objects.html";
            PolicyHtmlFile = _targetFolder + "\\" + _policyPackageName + ".html";
            PolicyOptimizedHtmlFile = _targetFolder + "\\" + _policyPackageOptimizedName + ".html";
            NatHtmlFile = _targetFolder + "\\" + _vendorFileName + "_NAT.html";
        }

        public void ChangeTargetFolder(string targetFolderNew, string targetFileNameNew)
        {
            _targetFolder = targetFolderNew;
            _vendorFileName = !string.IsNullOrEmpty(targetFileNameNew) ? Regex.Replace(targetFileNameNew, @"\s+", "_") : ""; ;

            // policy package names
            _policyPackageName = _vendorFileName + "_policy";
            _policyPackageOptimizedName = _vendorFileName + "_policy_opt";

            // script files
            ObjectsScriptFile = _targetFolder + "\\" + _vendorFileName + "_objects.sh";
            PolicyScriptFile = _targetFolder + "\\" + _policyPackageName + ".sh";
            PolicyOptimizedScriptFile = _targetFolder + "\\" + _policyPackageOptimizedName + ".sh";

            // HTML files
            VendorHtmlFile = _targetFolder + "\\" + _vendorFileName + ".html";
            WarningsHtmlFile = _targetFolder + "\\" + _vendorFileName + "_warnings.html";
            ErrorsHtmlFile = _targetFolder + "\\" + _vendorFileName + "_errors.html";
            ObjectsHtmlFile = _targetFolder + "\\" + _vendorFileName + "_objects.html";
            PolicyHtmlFile = _targetFolder + "\\" + _policyPackageName + ".html";
            PolicyOptimizedHtmlFile = _targetFolder + "\\" + _policyPackageOptimizedName + ".html";
            NatHtmlFile = _targetFolder + "\\" + _vendorFileName + "_NAT.html";
        }

        public void CleanCheckPointObjectsLists()
        {
            _hasNATConversionIncident = false;
            _cpSimpleGateway = null;
            _cpDomains.Clear();
            _cpHosts.Clear();
            _cpNetworks.Clear();
            _cpRanges.Clear();
            _cpNetworkGroups.Clear();
            _cpGroupsWithExclusion.Clear();
            _cpZones.Clear();
            _cpTcpServices.Clear();
            _cpUdpServices.Clear();
            _cpSctpServices.Clear();
            _cpIcmpServices.Clear();
            _cpRpcServices.Clear();
            _cpDceRpcServices.Clear();
            _cpOtherServices.Clear();
            _cpServiceGroups.Clear();
            _cpApplicationGroups.Clear();
            _cpTimes.Clear();
            _cpTimeGroups.Clear();
            _cpAccessRoles.Clear();
            _cpPackages.Clear();
            _cpNatRules.Clear();
        }

        #region Abstract

        public abstract void Convert(bool convertNat);
        public abstract int RulesInConvertedPackage();
        public abstract int RulesInConvertedOptimizedPackage();
        public abstract int RulesInNatLayer();
        public abstract void ExportConfigurationAsHtml();
        public abstract void ExportPolicyPackagesAsHtml();
        protected abstract string GetVendorName();

        #endregion

        public void ExportNatLayerAsHtml()
        {
            if (RulesInNatLayer() < 1) // == 0)
            {
                return;
            }

            using (var file = new StreamWriter(NatHtmlFile, false))
            {
                var rulesWithConversionErrors = new List<string>();
                var rulesWithConversionInfos = new List<string>();
                int errorsCount = 0;
                int infosCount = 0;

                file.WriteLine("<html>");
                file.WriteLine("<head>");
                file.WriteLine("<style>");
                file.WriteLine("  body { font-family: Helvetica; margin-left: 0px; margin-right: 0px; margin-top: 0px; }");
                file.WriteLine("  table { border-collapse: collapse; border: 1px solid gray; margin: 20px; }");
                file.WriteLine("  td { vertical-align: text-top; padding: 6px; border: 1px solid gray; }");
                file.WriteLine("  th { vertical-align: text-top; padding: 6px; border: 1px solid gray; background-color: rgb(87,99,114); font-weight: bold; color: white; }");
                file.WriteLine("  .report_time { font-family: Segoe UI; font-size: 14px; font-weight: normal; border-left: 1px solid #c9c9c9; padding: 10px; } ");
                file.WriteLine("  .rule_number { background-color: rgb(245,245,245); text-align: right; } ");
                file.WriteLine("  .errors_header { background-color: rgb(213,51,30); } ");
                file.WriteLine("  .disabled_rule { text-decoration: line-through; } ");
                file.WriteLine("  .comments { font-family: Lucida Console; }");
                file.WriteLine("</style>");
                file.WriteLine("<script>");
                file.WriteLine("   var errorsCounter = 0;");
                file.WriteLine("   var infosCounter = 0;");
                file.WriteLine("   function displayIncidentsCount() {");
                file.WriteLine("      if (errorsCounter > 0) {");
                file.WriteLine("         var elem1 = document.getElementById('errorsCountHost');");
                file.WriteLine("         if (elem1 != null) {");
                file.WriteLine("            elem1.style.display = 'inline';");
                file.WriteLine("         }");
                file.WriteLine("         var elem2 = document.getElementById('errorsCount');");
                file.WriteLine("         if (elem2 != null) {");
                file.WriteLine("            elem2.innerText = elem2.innerText + errorsCounter;");
                file.WriteLine("         }");
                file.WriteLine("      }");
                file.WriteLine("      if (infosCounter > 0) {");
                file.WriteLine("         var elem1 = document.getElementById('infosCountHost');");
                file.WriteLine("         if (elem1 != null) {");
                file.WriteLine("            elem1.style.display = 'inline';");
                file.WriteLine("         }");
                file.WriteLine("         var elem2 = document.getElementById('infosCount');");
                file.WriteLine("         if (elem2 != null) {");
                file.WriteLine("            elem2.innerText = elem2.innerText + infosCounter;");
                file.WriteLine("         }");
                file.WriteLine("      }");
                file.WriteLine("   }");
                file.WriteLine("</script>");
                file.WriteLine("</head>");
                file.WriteLine("<body onLoad='displayIncidentsCount()'>");

                // Generate the report header
                file.WriteLine("<div style='height: 70px; line-height: 70px; background-color: black; padding-left: 20px; margin-bottom: 35px; color: white; font-family: Segoe UI; font-size: 20px;'>");
                file.WriteLine("   <img style='width: 33px; height: 32px; padding-top: 20;' " + HtmlToolLogoImageSource + "/>");
                file.WriteLine("   <span style='font-weight: bold; vertical-align: top;'>SmartMove</span>");
                file.WriteLine("   <span style='font-size: 10px; position: absolute; padding-top: 4px; margin-left: 10px;'>ver " + _toolVersion + "</span>");
                file.WriteLine("   <img style='width: 118px; height: 20px; position: absolute; right: 20; padding-top: 25;' " + HtmlCPLogoImageSource + "/>");
                file.WriteLine("</div>");
                file.WriteLine("<div style='font-size: 30px; font-weight: lighter; margin-left: 20px; margin-bottom: 30px;'>CONVERSION REPORT  ");
                file.WriteLine("   <span id='reportTime' class='report_time'>" + GeneratePackageHtmlReportDateTime() + "</span>");
                file.WriteLine("</div>");
                file.WriteLine("<div style='font-size: 16px; margin-left: 20px; margin-bottom: 15px;'>");
                file.WriteLine("   <span style='font-weight: normal;'>NAT Layer</span>");
                file.WriteLine("</div>");

                if (_hasNATConversionIncident)
                {
                    file.WriteLine("<div style='margin-left: 20px;'>");
                    file.WriteLine("   <span style='font-weight: bold;'>Found Conversion Issues:</span>");
                    file.WriteLine("   <span id='errorsCountHost' style='display: none; margin-left: 10px; vertical-align: middle;'>" + string.Format(HtmlErrorImageTagFormat, "Conversion Errors"));
                    file.WriteLine("      <a id='errorsCount' href='#PolicyConversionErrors' style='margin-left: 2px; vertical-align: top;'></a>");
                    file.WriteLine("   </span>");
                    file.WriteLine("   <span id='infosCountHost' style='display: none; margin-left: 10px; vertical-align: middle;'>" + string.Format(HtmlAlertImageTagFormat, "Conversion Notifications"));
                    file.WriteLine("      <a id='infosCount' href='#PolicyConversionInfos' style='margin-left: 2px; vertical-align: top;'/></a>");
                    file.WriteLine("   </span>");
                    file.WriteLine("</div>");
                }

                // Generate the report body
                file.WriteLine("<table>");
                file.WriteLine("   <tr>");
                file.WriteLine("      <th>No.</th> <th>Source</th> <th>Destination</th> <th>Service</th> <th>Translated-Source</th> <th>Translated-Destination</th> <th>Translated-Service</th> <th>Install On</th> <th>Comments</th>");
                file.WriteLine("   </tr>");

                int ruleNumber = 1;

                foreach (CheckPoint_NAT_Rule rule in _cpNatRules)
                {
                    string source = (rule.Source == null) ? CheckPointObject.Any : NatRuleItem2Html(rule.Source.Name);
                    string dest = (rule.Destination == null) ? CheckPointObject.Any : NatRuleItem2Html(rule.Destination.Name);
                    string service = (rule.Service == null) ? CheckPointObject.Any : NatRuleItem2Html(rule.Service.Name);
                    string xsource = (rule.TranslatedSource == null) ? "=orig" : NatRuleItem2Html(rule.TranslatedSource.Name);
                    string xdest = (rule.TranslatedDestination == null) ? "=orig" : NatRuleItem2Html(rule.TranslatedDestination.Name);
                    string xservice = (rule.TranslatedService == null) ? "=orig" : NatRuleItem2Html(rule.TranslatedService.Name);

                    if (xsource != "=orig")
                    {
                        xsource = ((rule.Method == CheckPoint_NAT_Rule.NatMethod.Static) ? "static: " : "hide: ") + xsource;
                    }
                    if (xdest != "=orig")
                    {
                        xdest = "static: " + xdest;
                    }

                    string curRuleHtmlPart;
                    var curRuleHtmlFull = new List<string>();
                    var ruleConversionIncidentType = ConversionIncidentType.None;

                    if (rule.Enabled)
                    {
                        curRuleHtmlPart = "  <tr id=\"" + ruleNumber + "\">";
                    }
                    else
                    {
                        curRuleHtmlPart = "  <tr class='disabled_rule' id=\"" + ruleNumber + "\">";
                    }
                    file.WriteLine(curRuleHtmlPart);
                    curRuleHtmlFull.Add(curRuleHtmlPart);

                    var sbRuleNumberColumnTag = new StringBuilder();
                    var sbRuleNumberColumnWithLinkBackTag = new StringBuilder();
                    sbRuleNumberColumnTag.Append("      <td class='rule_number'>");
                    if (rule.ConversionIncidentType != ConversionIncidentType.None)
                    {
                        sbRuleNumberColumnTag.Append(BuildConversionIncidentLinkTag(rule.ConvertedCommandId));
                        ruleConversionIncidentType = rule.ConversionIncidentType;
                    }
                    if (!rule.Enabled)
                    {
                        sbRuleNumberColumnTag.Append(HtmlDisabledImageTag);
                    }
                    sbRuleNumberColumnWithLinkBackTag.Append(sbRuleNumberColumnTag);   // save this XML portion to be continued bellow
                    sbRuleNumberColumnTag.Append(ruleNumber);
                    sbRuleNumberColumnTag.Append("</td>");
                    curRuleHtmlPart = sbRuleNumberColumnTag.ToString();
                    file.WriteLine(curRuleHtmlPart);

                    sbRuleNumberColumnWithLinkBackTag.Append("<a href=\"#");
                    sbRuleNumberColumnWithLinkBackTag.Append(ruleNumber);
                    sbRuleNumberColumnWithLinkBackTag.Append("\">");
                    sbRuleNumberColumnWithLinkBackTag.Append(ruleNumber);
                    sbRuleNumberColumnWithLinkBackTag.Append("</a></td>");
                    curRuleHtmlFull.Add(sbRuleNumberColumnWithLinkBackTag.ToString());

                    if (rule.Source != null && rule.Source.ConversionIncidentType != ConversionIncidentType.None)
                    {
                        curRuleHtmlPart = "      <td>" + BuildConversionIncidentLinkTag(rule.Source.ConvertedCommandId) + source + "</td>";
                        if (rule.Source.ConversionIncidentType > ruleConversionIncidentType)
                        {
                            ruleConversionIncidentType = rule.Source.ConversionIncidentType;
                        }
                    }
                    else
                    {
                        curRuleHtmlPart = "      <td>" + source + "</td>";
                    }
                    file.WriteLine(curRuleHtmlPart);
                    curRuleHtmlFull.Add(curRuleHtmlPart);

                    if (rule.Destination != null && rule.Destination.ConversionIncidentType != ConversionIncidentType.None)
                    {
                        curRuleHtmlPart = "      <td>" + BuildConversionIncidentLinkTag(rule.Destination.ConvertedCommandId) + dest + "</td>";
                        if (rule.Destination.ConversionIncidentType > ruleConversionIncidentType)
                        {
                            ruleConversionIncidentType = rule.Destination.ConversionIncidentType;
                        }
                    }
                    else
                    {
                        curRuleHtmlPart = "      <td>" + dest + "</td>";
                    }
                    file.WriteLine(curRuleHtmlPart);
                    curRuleHtmlFull.Add(curRuleHtmlPart);

                    if (rule.Service != null && rule.Service.ConversionIncidentType != ConversionIncidentType.None)
                    {
                        curRuleHtmlPart = "      <td>" + BuildConversionIncidentLinkTag(rule.Service.ConvertedCommandId) + service + "</td>";
                        if (rule.Service.ConversionIncidentType > ruleConversionIncidentType)
                        {
                            ruleConversionIncidentType = rule.Service.ConversionIncidentType;
                        }
                    }
                    else
                    {
                        curRuleHtmlPart = "      <td>" + service + "</td>";
                    }
                    file.WriteLine(curRuleHtmlPart);
                    curRuleHtmlFull.Add(curRuleHtmlPart);

                    if (rule.TranslatedSource != null && rule.TranslatedSource.ConversionIncidentType != ConversionIncidentType.None)
                    {
                        curRuleHtmlPart = "      <td>" + BuildConversionIncidentLinkTag(rule.TranslatedSource.ConvertedCommandId) + xsource + "</td>";
                        if (rule.TranslatedSource.ConversionIncidentType > ruleConversionIncidentType)
                        {
                            ruleConversionIncidentType = rule.TranslatedSource.ConversionIncidentType;
                        }
                    }
                    else
                    {
                        curRuleHtmlPart = "      <td>" + xsource + "</td>";
                    }
                    file.WriteLine(curRuleHtmlPart);
                    curRuleHtmlFull.Add(curRuleHtmlPart);

                    if (rule.TranslatedDestination != null && rule.TranslatedDestination.ConversionIncidentType != ConversionIncidentType.None)
                    {
                        curRuleHtmlPart = "      <td>" + BuildConversionIncidentLinkTag(rule.TranslatedDestination.ConvertedCommandId) + xdest + "</td>";
                        if (rule.TranslatedDestination.ConversionIncidentType > ruleConversionIncidentType)
                        {
                            ruleConversionIncidentType = rule.TranslatedDestination.ConversionIncidentType;
                        }
                    }
                    else
                    {
                        curRuleHtmlPart = "      <td>" + xdest + "</td>";
                    }
                    file.WriteLine(curRuleHtmlPart);
                    curRuleHtmlFull.Add(curRuleHtmlPart);

                    if (rule.TranslatedService != null && rule.TranslatedService.ConversionIncidentType != ConversionIncidentType.None)
                    {
                        curRuleHtmlPart = "      <td>" + BuildConversionIncidentLinkTag(rule.TranslatedService.ConvertedCommandId) + xservice + "</td>";
                        if (rule.TranslatedService.ConversionIncidentType > ruleConversionIncidentType)
                        {
                            ruleConversionIncidentType = rule.TranslatedService.ConversionIncidentType;
                        }
                    }
                    else
                    {
                        curRuleHtmlPart = "      <td>" + xservice + "</td>";
                    }
                    file.WriteLine(curRuleHtmlPart);
                    curRuleHtmlFull.Add(curRuleHtmlPart);

                    var dummy = ConversionIncidentType.None;
                    curRuleHtmlPart = "      <td>" + RuleStringList2Html(rule.Target, false, CheckPointObject.All, ref dummy) + "</td>";
                    file.WriteLine(curRuleHtmlPart);
                    curRuleHtmlFull.Add(curRuleHtmlPart);

                    curRuleHtmlPart = "      <td class='comments'>" + rule.Comments + "</td>";
                    file.WriteLine(curRuleHtmlPart);
                    curRuleHtmlFull.Add(curRuleHtmlPart);

                    file.WriteLine("  </tr>");
                    curRuleHtmlFull.Add("  </tr>");

                    if (_hasNATConversionIncident && ruleConversionIncidentType != ConversionIncidentType.None)
                    {
                        if (ruleConversionIncidentType == ConversionIncidentType.ManualActionRequired)
                        {
                            ++errorsCount;
                            rulesWithConversionErrors.AddRange(curRuleHtmlFull);
                        }
                        else
                        {
                            ++infosCount;
                            rulesWithConversionInfos.AddRange(curRuleHtmlFull);
                        }
                    }

                    ruleNumber++;
                }

                file.WriteLine("</table>");

                if (rulesWithConversionErrors.Count > 0 || rulesWithConversionInfos.Count > 0)
                {
                    file.WriteLine("<div id=\"PolicyConversionIncidents\" style='margin-left: 20px;'><h2>NAT Conversion Issues</h2></div>");
                }

                // Generate the errors report
                if (rulesWithConversionErrors.Count > 0)
                {
                    file.WriteLine("<script>");
                    file.WriteLine("   errorsCounter = " + errorsCount + ";");
                    file.WriteLine("</script>");

                    file.WriteLine("<div id=\"PolicyConversionErrors\" style='margin-left: 20px;'><h3>Conversion Errors</h3></div>");
                    file.WriteLine("<table style='background-color: rgb(255,255,150);'>");
                    file.WriteLine("   <tr>");
                    file.WriteLine("      <th class='errors_header'>No.</th> <th class='errors_header'>Source</th> <th class='errors_header'>Destination</th> <th class='errors_header'>Service</th> <th class='errors_header'>Translated-Source</th> <th class='errors_header'>Translated-Destination</th> <th class='errors_header'>Translated-Service</th> <th>Install On</th> <th class='errors_header'>Comments</th>");
                    file.WriteLine("   </tr>");

                    foreach (var ruleHtml in rulesWithConversionErrors)
                    {
                        file.WriteLine(ruleHtml);
                    }

                    file.WriteLine("</table>");
                }

                // Generate the information report
                if (rulesWithConversionInfos.Count > 0)
                {
                    file.WriteLine("<script>");
                    file.WriteLine("   infosCounter = " + infosCount + ";");
                    file.WriteLine("</script>");

                    file.WriteLine("<div id=\"PolicyConversionInfos\" style='margin-left: 20px;'><h3>Conversion Notifications</h3></div>");
                    file.WriteLine("<table style='background-color: rgb(220,240,247);'>");
                    file.WriteLine("   <tr>");
                    file.WriteLine("      <th class='errors_header'>No.</th> <th class='errors_header'>Source</th> <th class='errors_header'>Destination</th> <th class='errors_header'>Service</th> <th class='errors_header'>Translated-Source</th> <th class='errors_header'>Translated-Destination</th> <th class='errors_header'>Translated-Service</th> <th>Install On</th> <th class='errors_header'>Comments</th>");
                    file.WriteLine("   </tr>");

                    foreach (var ruleHtml in rulesWithConversionInfos)
                    {
                        file.WriteLine(ruleHtml);
                    }

                    file.WriteLine("</table>");
                }

                file.WriteLine("</body>");
                file.WriteLine("</html>");
            }

        }

        protected virtual bool AddCheckPointObject(CheckPointObject cpObject)
        {
            if (_cpObjects.HasObject(cpObject.Name))
            {
                return true;
            }

            bool found = false;

            if (cpObject.GetType().ToString().EndsWith("_Domain"))
            {
                _cpDomains.Add((CheckPoint_Domain)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_Host"))
            {
                _cpHosts.Add((CheckPoint_Host)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_Network"))
            {
                var cpNetwork = (CheckPoint_Network)cpObject;
                if (cpNetwork.Netmask == "0.0.0.0")
                {
                    var cpRange = new CheckPoint_Range();
                    cpRange.Name = cpNetwork.Name;
                    cpRange.Comments = cpNetwork.Comments;
                    cpRange.RangeFrom = "0.0.0.0";
                    cpRange.RangeTo = "255.255.255.255";
                    _cpRanges.Add(cpRange);
                }
                else
                {
                    _cpNetworks.Add(cpNetwork);
                }
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_Range"))
            {
                _cpRanges.Add((CheckPoint_Range)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_NetworkGroup"))
            {
                _cpNetworkGroups.Add((CheckPoint_NetworkGroup)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_GroupWithExclusion"))
            {
                _cpGroupsWithExclusion.Add((CheckPoint_GroupWithExclusion)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_SimpleGateway"))
            {
                _cpSimpleGateway = (CheckPoint_SimpleGateway)cpObject;
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_Zone"))
            {
                _cpZones.Add((CheckPoint_Zone)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_TcpService"))
            {
                _cpTcpServices.Add((CheckPoint_TcpService)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_UdpService"))
            {
                _cpUdpServices.Add((CheckPoint_UdpService)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_SctpService"))
            {
                _cpSctpServices.Add((CheckPoint_SctpService)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_IcmpService"))
            {
                _cpIcmpServices.Add((CheckPoint_IcmpService)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_RpcService"))
            {
                _cpRpcServices.Add((CheckPoint_RpcService)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_DceRpcService"))
            {
                _cpDceRpcServices.Add((CheckPoint_DceRpcService)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_OtherService"))
            {
                _cpOtherServices.Add((CheckPoint_OtherService)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_ServiceGroup"))
            {
                _cpServiceGroups.Add((CheckPoint_ServiceGroup)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_ApplicationGroup"))
            {
                _cpApplicationGroups.Add((CheckPoint_ApplicationGroup)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_Time"))
            {
                _cpTimes.Add((CheckPoint_Time)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_TimeGroup"))
            {
                _cpTimeGroups.Add((CheckPoint_TimeGroup)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_AccessRole"))
            {
                _cpAccessRoles.Add((CheckPoint_AccessRole)cpObject);
                found = true;
            }

            if (cpObject.GetType().ToString().EndsWith("_Package"))
            {
                _cpPackages.Add((CheckPoint_Package)cpObject);
                found = true;
            }

            if (found)
            {
                _cpObjects.AddObject(cpObject);

                if (cpObject.Name != null && cpObject.Name.Contains(AutoGeneratedNameWithError))
                {
                    cpObject.ConversionIncidentType = ConversionIncidentType.ManualActionRequired;
                }
            }
            else
            {
                Console.WriteLine("Check Point object type " + cpObject.GetType() + " not found!!");
            }

            return found;
        }

        /// <summary>
        /// It may happen that several interfaces have topology that overlap, and therefore the generated network groups will also overlap.
        /// This will not work properly and may cause security issues when using these network groups in firewall and NAT rulebases.
        /// To fix this, we should use network groups with exclusion to include/exclude the overlapping networks.
        /// The networks to include/exclude are calculated based on network ranges.
        /// </summary>
        protected List<string> Add_or_Modify_InterfaceNetworkGroups(List<CheckPoint_NetworkGroup> interfaceNetworkGroups)
        {
            var excludeNetworksFromInterface = new Dictionary<string, List<CheckPoint_Network>>();

            for (int i = 0; i < interfaceNetworkGroups.Count - 1; i++)
            {
                CheckPoint_NetworkGroup grp1 = interfaceNetworkGroups[i];

                for (int j = i + 1; j < interfaceNetworkGroups.Count; j++)
                {
                    CheckPoint_NetworkGroup grp2 = interfaceNetworkGroups[j];

                    for (int k = 0; k < grp1.Members.Count; k++)
                    {
                        string network1Name = grp1.Members[k];
                        var network1 = (CheckPoint_Network)_cpObjects.GetObject(network1Name);
                        UInt32[] range1 = NetworkUtils.GetNetworkRangeInNumbers(network1.Subnet, network1.Netmask);

                        for (int m = 0; m < grp2.Members.Count; m++)
                        {
                            string network2Name = grp2.Members[m];
                            var network2 = (CheckPoint_Network)_cpObjects.GetObject(network2Name);
                            UInt32[] range2 = NetworkUtils.GetNetworkRangeInNumbers(network2.Subnet, network2.Netmask);

                            // Check networks ranges overlap
                            if (((range2[0] >= range1[0]) && (range2[0] <= range1[1])) ||
                                ((range1[0] >= range2[0]) && (range1[0] <= range2[1])))
                            {
                                if (range1[1] - range1[0] > range2[1] - range2[0])
                                {
                                    if (excludeNetworksFromInterface.ContainsKey(grp1.Name))
                                    {
                                        excludeNetworksFromInterface[grp1.Name].Add(network2);
                                    }
                                    else
                                    {
                                        excludeNetworksFromInterface.Add(grp1.Name, new List<CheckPoint_Network> { network2 });
                                    }
                                }
                                else
                                {
                                    if (excludeNetworksFromInterface.ContainsKey(grp2.Name))
                                    {
                                        excludeNetworksFromInterface[grp2.Name].Add(network1);
                                    }
                                    else
                                    {
                                        excludeNetworksFromInterface.Add(grp2.Name, new List<CheckPoint_Network> { network1 });
                                    }
                                }
                            }
                        }
                    }
                }
            }

            var modifiedNetworkGroups = new List<string>();

            foreach (KeyValuePair<string, List<CheckPoint_Network>> kvp in excludeNetworksFromInterface)
            {
                modifiedNetworkGroups.Add(kvp.Key);

                // First, Rename original group name
                var origGroup = (CheckPoint_NetworkGroup)_cpObjects.GetObject(kvp.Key);
                _cpObjects.RemoveObject(origGroup.Name);
                origGroup.Name = kvp.Key + "_include";
                _cpObjects.AddObject(origGroup);

                var cpExcludedGroup = new CheckPoint_NetworkGroup();
                cpExcludedGroup.Name = kvp.Key + "_exclude";
                foreach (CheckPoint_Network network in kvp.Value)
                {
                    cpExcludedGroup.Members.Add(network.Name);
                }
                AddCheckPointObject(cpExcludedGroup);

                var cpGroupWithExclusion = new CheckPoint_GroupWithExclusion();
                cpGroupWithExclusion.Name = kvp.Key;
                cpGroupWithExclusion.Include = origGroup.Name;
                cpGroupWithExclusion.Except = cpExcludedGroup.Name;
                AddCheckPointObject(cpGroupWithExclusion);
            }

            return modifiedNetworkGroups;
        }

        protected IPRanges GetGroupRanges(CheckPoint_NetworkGroup cpNetworkGroup)
        {
            var ranges = new IPRanges();

            foreach (string memberName in cpNetworkGroup.Members)
            {
                var cpObject = _cpObjects.GetObject(memberName);
                if (cpObject != null)
                {
                    if (cpObject.GetType().ToString().EndsWith("_NetworkGroup"))
                    {
                        ranges += GetGroupRanges((CheckPoint_NetworkGroup)cpObject);
                    }
                    else
                    {
                        ranges += cpObject.GetIPRanges();
                    }
                }
            }

            return ranges;
        }

        protected IPRanges GetGroupWithExclusionRanges(CheckPoint_NetworkGroup includeGroup, CheckPoint_NetworkGroup excludeGroup)
        {
            IPRanges includeRanges = IPRanges.Merge(GetGroupRanges(includeGroup));
            IPRanges excludeRanges = IPRanges.Merge(GetGroupRanges(excludeGroup));

            var ranges = new IPRanges();

            foreach (IPRange range in includeRanges.Ranges)
            {
                ranges += IPRanges.Negate(range, excludeRanges);
            }

            return IPRanges.Merge(ranges);
        }

        protected void CreateObjectsScript()
        {

            using (var file = new StreamWriter(ObjectsScriptFile, false))
            {
                file.WriteLine(CLIScriptBuilder.GenerateScriptHeader(_toolVersion, true));
                file.WriteLine(CLIScriptBuilder.GenerateRunCommandScript("failed_objects.txt"));
                file.WriteLine(CLIScriptBuilder.GenerateLoginScript(_domainName, "failed_objects.txt"));

                if (LDAP_Account_Unit != null && !LDAP_Account_Unit.Trim().Equals(""))
                {
                    file.WriteLine("LDAPAU=" + LDAP_Account_Unit);
                    file.WriteLine("NUSE=`mgmt_cli show generic-objects name $LDAPAU -s id.txt |grep \"total:\" | cut -f2 -d\":\" | cut -c 2,`");
                    file.WriteLine(Environment.NewLine);
                }

                file.WriteLine(CLIScriptBuilder.GenerateDiagnosticsCommandScript("SmartMove_Create_Objects", GetVendorName()));

                int totalObjectsCount = _cpDomains.Count +
                                        _cpHosts.Count +
                                        _cpNetworks.Count +
                                        _cpRanges.Count +
                                        _cpNetworkGroups.Count +
                                        _cpGroupsWithExclusion.Count +
                                        _cpZones.Count +
                                        _cpTcpServices.Count +
                                        _cpUdpServices.Count +
                                        _cpSctpServices.Count +
                                        _cpIcmpServices.Count +
                                        _cpRpcServices.Count +
                                        _cpDceRpcServices.Count +
                                        _cpOtherServices.Count +
                                        _cpServiceGroups.Count +
                                        _cpApplicationGroups.Count +
                                        _cpTimes.Count +
                                        _cpTimeGroups.Count +
                                        _cpAccessRoles.Count;

                if (_cpSimpleGateway != null)
                {
                    ++totalObjectsCount;
                }

                if (totalObjectsCount > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Creating total of {0} Objects...", totalObjectsCount)));
                }

                if (_cpDomains.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "Domain", _cpDomains.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_Domain obj in _cpDomains)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpHosts.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "Host", _cpHosts.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_Host obj in _cpHosts)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpNetworks.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "Network", _cpNetworks.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_Network obj in _cpNetworks)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpRanges.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "Address Range", _cpRanges.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_Range obj in _cpRanges)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                CheckPoint_NetworkGroup allInternal = null;

                bool splitNetworkGroupsCreation = (_cpNetworkGroups.Count > 0 && _cpGroupsWithExclusion.Count > 0);

                if (_cpNetworkGroups.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "Network Group", _cpNetworkGroups.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_NetworkGroup obj in _cpNetworkGroups)
                    {
                        if (obj.Name == AllInternalNetwotkGroupName)
                        {
                            allInternal = obj;
                            continue;
                        }

                        if (splitNetworkGroupsCreation && obj.CreateAfterGroupsWithExclusion)
                        {
                            continue;
                        }

                        //if a group has no members
                        if (obj.Members.Count == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                            objectsCount++;
                            if (objectsCount % publishLatency == 0)
                            {
                                file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                            }
                            continue;
                        }

                        //if a group has more then max size for publish - generate part of group divided by small groups.
                        obj.MembersMaxPublishSize = groupsMaxBulkSize;
                        for (int i = 0; i < obj.Members.Count; i += groupsMaxBulkSize)
                        {
                            obj.MembersPublishIndex = i;

                            file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                            objectsCount++;
                            if (objectsCount % publishLatency == 0)
                            {
                                file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                            }
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpGroupsWithExclusion.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "Group with exclusion", _cpGroupsWithExclusion.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_GroupWithExclusion obj in _cpGroupsWithExclusion)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (splitNetworkGroupsCreation)
                {
                    int objectsCount = 0;
                    foreach (CheckPoint_NetworkGroup obj in _cpNetworkGroups)
                    {
                        if (!obj.CreateAfterGroupsWithExclusion)
                        {
                            continue;
                        }

                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (allInternal != null)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateObjectScript(allInternal));
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpSimpleGateway != null)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateObjectScript(_cpSimpleGateway));
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpZones.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "Zone", _cpZones.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_Zone obj in _cpZones)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpTcpServices.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "TCP Service", _cpTcpServices.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_TcpService obj in _cpTcpServices)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpUdpServices.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "UDP Service", _cpUdpServices.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_UdpService obj in _cpUdpServices)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpSctpServices.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "SCTP Service", _cpSctpServices.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_SctpService obj in _cpSctpServices)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpIcmpServices.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "ICMP Service", _cpIcmpServices.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_IcmpService obj in _cpIcmpServices)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpRpcServices.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "RPC Service", _cpRpcServices.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_RpcService obj in _cpRpcServices)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpDceRpcServices.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "DCE-RPC Service", _cpDceRpcServices.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_DceRpcService obj in _cpDceRpcServices)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpOtherServices.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "Other Service", _cpOtherServices.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_OtherService obj in _cpOtherServices)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpServiceGroups.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "Service Group", _cpServiceGroups.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_ServiceGroup obj in _cpServiceGroups)
                    {
                        //if a group has no members
                        if (obj.Members.Count == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                            objectsCount++;
                            if (objectsCount % publishLatency == 0)
                            {
                                file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                            }
                            continue;
                        }

                        //if a group has more then max size for publish - generate part of group divided by small groups.
                        obj.MembersMaxPublishSize = groupsMaxBulkSize;
                        for (int i = 0; i < obj.Members.Count; i += groupsMaxBulkSize)
                        {
                            obj.MembersPublishIndex = i;

                            file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                            objectsCount++;
                            if (objectsCount % publishLatency == 0)
                            {
                                file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                            }
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpApplicationGroups.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "Application Group", _cpApplicationGroups.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_ApplicationGroup obj in _cpApplicationGroups)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpTimes.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "Time ", _cpTimes.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_Time obj in _cpTimes)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpTimeGroups.Count > 0)
                {
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "Time Group", _cpTimeGroups.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_TimeGroup obj in _cpTimeGroups)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(obj));

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                }

                if (_cpAccessRoles.Count > 0)
                {
                    file.WriteLine("if [[ $NUSE -ne 0 ]]; then");

                    file.WriteLine("  " + CLIScriptBuilder.GenerateInstructionScript(string.Format("Create {0} Objects (x{1}) ", "Access Role", _cpAccessRoles.Count)));
                    int objectsCount = 0;
                    foreach (CheckPoint_AccessRole obj in _cpAccessRoles)
                    {
                        string scriptInstruction = obj.ToCLIScriptInstruction();
                        if (!string.IsNullOrEmpty(scriptInstruction))
                        {
                            file.WriteLine("  " + "echo '" + scriptInstruction + "'");
                        }

                        var sb_add = new StringBuilder();
                        sb_add.Append("cmd='mgmt_cli ")
                            .Append(obj.ToCLIScript())
                            .Append(" ignore-warnings true -s id.txt --user-agent mgmt_cli_smartmove'");

                        file.WriteLine("  " + sb_add.ToString());
                        file.WriteLine("  " + "run_command");

                        for (int i = 0; i < obj.Users.Count; i++)
                        {
                            var sb_set = new StringBuilder();

                            sb_set.Append("cmd='mgmt_cli ")
                                .Append("set access-role ")
                                .Append("name " + "\"" + obj.SafeName() + "\" ");

                            if (obj.Networks.Count == 0)
                            {
                                sb_set.Append("networks \"any\" ");
                            }
                            else
                            {
                                obj.Networks.ForEach(x => sb_set.Append("networks." + obj.Networks.IndexOf(x) + " \"" + x + "\" "));
                            }

                            sb_set
                                .Append("users.add.source $LDAPAU ")
                                .Append("users.add.selection." + i + " \"" + obj.Users[i].Name + "\" ")
                                .Append(!(string.IsNullOrWhiteSpace(obj.Users[i].BaseDn)) ? "users.add.base-dn \"" + obj.Users[i].BaseDn + "\"" : "")
                                .Append(" ignore-warnings true -s id.txt --user-agent mgmt_cli_smartmove'");

                            file.WriteLine("  " + sb_set.ToString());
                            file.WriteLine("  " + "run_command");
                        }

                        objectsCount++;
                        if (objectsCount % publishLatency == 0)
                        {
                            file.WriteLine("  " + CLIScriptBuilder.GeneratePublishScript());
                        }
                    }
                    file.WriteLine("  " + CLIScriptBuilder.GeneratePublishScript());

                    file.WriteLine("fi");
                }


                file.WriteLine(CLIScriptBuilder.GenerateScriptFooter("failed_objects.txt"));
            }
        }

        protected void validatePackage(CheckPoint_Package package)
        {
            if (package?.SubPolicies != null && package.SubPolicies.Count > SubPoliciesMaxNumber)
            {
                throw new InvalidDataException("Policy exceeds the maximum number of supported policy layers.");
            }
        }

        protected void CreatePackagesScript()
        {
            const int publishLatency = 100;
            int packageNumber = 0;

            foreach (CheckPoint_Package package in _cpPackages)
            {
                validatePackage(package);
                ++packageNumber;

                string filename = _targetFolder + "\\" + package.Name + ".sh";
                string errorsReportFile = (packageNumber == 1) ? "failed_package.txt" : "failed_package_opt.txt";
                string diagnosticsTarget = (packageNumber == 1) ? "SmartMove_Create_Policy" : "SmartMove_Create_Optimized_Policy";

                using (var file = new StreamWriter(filename, false))
                {
                    file.WriteLine(CLIScriptBuilder.GenerateScriptHeader(_toolVersion, false));
                    file.WriteLine(CLIScriptBuilder.GenerateRunCommandScript(errorsReportFile));
                    file.WriteLine(CLIScriptBuilder.GenerateLoginScript(_domainName, errorsReportFile));
                    file.WriteLine(CLIScriptBuilder.GenerateDiagnosticsCommandScript(diagnosticsTarget, GetVendorName()));

                    file.WriteLine(CLIScriptBuilder.GenerateObjectScript(package));

                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Layers: Creating {0} sub-policies", package.SubPolicies.Count())));
                    foreach (CheckPoint_Layer layer in package.SubPolicies)
                    {
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(layer));

                        // !!! Attention !!! -- the rules are created in the reverse order but will be inserted at the TOP (!!!) position,
                        //                      so they are created in the correct order!
                        file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Add rules to layer {0}", layer.Name)));
                        int rulesCount = 0;
                        for (int counter = layer.Rules.Count - 1; counter >= 0; counter--)
                        {
                            CheckPoint_Rule rule = layer.Rules[counter];
                            file.WriteLine(CLIScriptBuilder.GenerateObjectScript(rule));

                            rulesCount++;
                            if (rulesCount % publishLatency == 0)
                            {
                                file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                                file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Add rules to layer {0}", layer.Name)));
                            }
                            file.WriteLine(CLIScriptBuilder.GenerateRuleInstructionScript(string.Format("rule {0}/{1}", rulesCount, layer.Rules.Count)));
                        }
                        file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                    }
                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());

                    // Enabling Applications and URL Filtering in parent layer
                    if (package.ParentLayer.ApplicationsAndUrlFiltering)
                    {
                        file.WriteLine("echo 'Enabling Applications and URL Filtering in parent layer vsys1_policy Network'");
                        file.WriteLine("cmd='mgmt_cli set access-layer " +
                                        "name \"" + package.ParentLayer.Name + "\" " +
                                        "applications-and-url-filtering \"true\" " +
                                        "ignore-warnings true -s id.txt --user-agent mgmt_cli_smartmove'");
                        file.WriteLine("run_command");
                        file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                    }
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Add rules to parent layer {0}", package.NameOfAccessLayer)));
                    // !!! Attention !!! -- the rules are created in the reverse order but will be inserted at the TOP (!!!) position,
                    //                      so they are created in the correct order!
                    int parentRulesCount = 0;
                    // SKIP the creation of cleanup rule, it is automatically generated during package creation!!!
                    for (int counter = package.ParentLayer.Rules.Count - 2; counter >= 0; counter--)
                    {
                        CheckPoint_Rule parentRule = package.ParentLayer.Rules[counter];
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(parentRule));

                        parentRulesCount++;
                        if (parentRulesCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                            file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Add rules to parent layer {0}", package.NameOfAccessLayer)));
                        }
                        file.WriteLine(CLIScriptBuilder.GenerateRuleInstructionScript(string.Format("rule {0}/{1}", parentRulesCount, package.ParentLayer.Rules.Count - 1)));
                    }

                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());

                    // !!! Attention !!! -- the rules are created in the reverse order but will be inserted at the TOP (!!!) position,
                    //                      so they are created in the correct order!
                    file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Add rules to NAT layer")));
                    int natRulesCount = 0;
                    for (int counter = _cpNatRules.Count - 1; counter >= 0; counter--)
                    {
                        CheckPoint_NAT_Rule rule = _cpNatRules[counter];
                        rule.Package = package.Name;
                        file.WriteLine(CLIScriptBuilder.GenerateObjectScript(rule));

                        natRulesCount++;
                        if (natRulesCount % publishLatency == 0)
                        {
                            file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                            file.WriteLine(CLIScriptBuilder.GenerateInstructionScript(string.Format("Add rules to NAT layer")));
                        }
                        file.WriteLine(CLIScriptBuilder.GenerateRuleInstructionScript(string.Format("rule {0}/{1}", natRulesCount, _cpNatRules.Count)));
                    }

                    file.WriteLine(CLIScriptBuilder.GeneratePublishScript());
                    file.WriteLine(CLIScriptBuilder.GenerateScriptFooter(errorsReportFile));
                }
            }
        }

        protected void CreateObjectsHtml()
        {
            using (var file = new StreamWriter(ObjectsHtmlFile, false))
            {
                file.WriteLine("<html>");
                file.WriteLine("<head>");
                file.WriteLine("<style>");
                file.WriteLine("  body { font-family: Arial; }");
                file.WriteLine("</style>");
                file.WriteLine("</head>");

                file.WriteLine("<body>");

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "Domains", _cpDomains.Count());
                foreach (CheckPoint_Domain obj in _cpDomains)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "Hosts", _cpHosts.Count());
                foreach (CheckPoint_Host obj in _cpHosts)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "Networks", _cpNetworks.Count());
                foreach (CheckPoint_Network obj in _cpNetworks)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "Ranges", _cpRanges.Count());
                foreach (CheckPoint_Range obj in _cpRanges)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "Network Groups", _cpNetworkGroups.Count());
                foreach (CheckPoint_NetworkGroup obj in _cpNetworkGroups)
                {
                    if (obj.Members.Count > groupsMaxBulkSize)
                    {
                        obj.MembersMaxPublishSize = groupsMaxBulkSize;
                        for (int i = 0; i < obj.Members.Count; i += groupsMaxBulkSize)
                        {
                            file.WriteLine("<div id=\"" + obj.Name + "_" + i + "\">");
                            
                            obj.MembersPublishIndex = i;
                            file.WriteLine(obj.ToCLIScript());

                            file.WriteLine("</div>");
                        }
                    }
                    else
                    {
                        file.WriteLine("<div id=\"" + obj.Name + "\">");
                        file.WriteLine(obj.ToCLIScript());
                        file.WriteLine("</div>");
                    }
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "Groups with exclusion", _cpGroupsWithExclusion.Count());
                foreach (CheckPoint_GroupWithExclusion obj in _cpGroupsWithExclusion)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                if (_cpSimpleGateway != null)
                {
                    file.WriteLine("<h2> Simple Gateway Object (x1) </h2>");
                    file.WriteLine("<div id=\"" + _cpSimpleGateway.Name + "\">");
                    file.WriteLine(_cpSimpleGateway.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "Zones", _cpZones.Count());
                foreach (CheckPoint_Zone obj in _cpZones)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "TCP Services", _cpTcpServices.Count());
                foreach (CheckPoint_TcpService obj in _cpTcpServices)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "UDP Services", _cpUdpServices.Count());
                foreach (CheckPoint_UdpService obj in _cpUdpServices)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "SCTP Services", _cpSctpServices.Count());
                foreach (CheckPoint_SctpService obj in _cpSctpServices)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "ICMP Services", _cpIcmpServices.Count());
                foreach (CheckPoint_IcmpService obj in _cpIcmpServices)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "RPC Services", _cpRpcServices.Count());
                foreach (CheckPoint_RpcService obj in _cpRpcServices)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "DCE-RPC Services", _cpDceRpcServices.Count());
                foreach (CheckPoint_DceRpcService obj in _cpDceRpcServices)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "Other Services", _cpOtherServices.Count());
                foreach (CheckPoint_OtherService obj in _cpOtherServices)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "Service Groups", _cpServiceGroups.Count());
                foreach (CheckPoint_ServiceGroup obj in _cpServiceGroups)
                {
                    if (obj.Members.Count > groupsMaxBulkSize)
                    {
                        obj.MembersMaxPublishSize = groupsMaxBulkSize;
                        for (int i = 0; i < obj.Members.Count; i += groupsMaxBulkSize)
                        {
                            file.WriteLine("<div id=\"" + obj.Name + "_" + i + "\">");

                            obj.MembersPublishIndex = i;
                            file.WriteLine(obj.ToCLIScript());

                            file.WriteLine("</div>");
                        }
                    }
                    else
                    {
                        file.WriteLine("<div id=\"" + obj.Name + "\">");
                        file.WriteLine(obj.ToCLIScript());
                        file.WriteLine("</div>");
                    }
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "Application Groups", _cpApplicationGroups.Count());
                foreach (CheckPoint_ApplicationGroup obj in _cpApplicationGroups)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "Times ", _cpTimes.Count());
                foreach (CheckPoint_Time obj in _cpTimes)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "Time Groups", _cpTimeGroups.Count());
                foreach (CheckPoint_TimeGroup obj in _cpTimeGroups)
                {
                    file.WriteLine("<div id=\"" + obj.Name + "\">");
                    file.WriteLine(obj.ToCLIScript());
                    file.WriteLine("</div>");
                }

                file.WriteLine("<h2> {0} Objects (x{1}) </h2>", "Access Roles", _cpAccessRoles.Count());
                foreach (CheckPoint_AccessRole obj in _cpAccessRoles)
                {
                    if (obj.Users.Count > 0)
                    {
                        file.WriteLine("<div id=\"" + obj.Name + "\">");

                        var sb_add = new StringBuilder();
                        sb_add.Append("add access-role ")
                            .Append("name " + "\"" + obj.SafeName() + "\" ");

                        if (obj.Networks.Count == 0)
                        {
                            sb_add.Append("networks \"any\" ");
                        }
                        else
                        {
                            obj.Networks.ForEach(x => sb_add.Append("networks." + obj.Networks.IndexOf(x) + " \"" + x + "\" "));
                        }

                        sb_add
                            .Append("users.source " + LDAP_Account_Unit + " ");

                        file.WriteLine(sb_add.ToString());

                        file.WriteLine("</div>");

                        for (int i = 0; i < obj.Users.Count; i++)
                        {
                            file.WriteLine("<div id=\"" + obj.Name + "_user_" + i + "\">");

                            var sb_set = new StringBuilder();
                            sb_set.Append("set access-role ")
                                .Append("name " + "\"" + obj.SafeName() + "\" ");

                            if (obj.Networks.Count == 0)
                            {
                                sb_set.Append("networks \"any\" ");
                            }
                            else
                            {
                                obj.Networks.ForEach(x => sb_set.Append("networks." + obj.Networks.IndexOf(x) + " \"" + x + "\" "));
                            }

                            sb_set
                                .Append("users.source " + LDAP_Account_Unit + " ")
                                .Append("users.add.selection." + i + " \"" + obj.Users[i].Name + "\" ")
                                .Append(!(string.IsNullOrWhiteSpace(obj.Users[i].BaseDn)) ? "users.add.base-dn \"" + obj.Users[i].BaseDn + "\"" : "");


                            file.WriteLine(sb_set.ToString());

                            file.WriteLine("</div>");
                        }
                    }
                }

                file.WriteLine("</body>");
                file.WriteLine("</html>");
            }
        }

        protected string BuildConversionIncidentInfo(int incidentLineNumber, out ConversionIncidentType highestIncidentType)
        {
            string conversionIncidentInfo = "";
            highestIncidentType = ConversionIncidentType.None;

            if (_conversionIncidentsByLineNumber.Any() && _conversionIncidentsByLineNumber.ContainsKey(incidentLineNumber))
            {
                var sb = new StringBuilder();
                highestIncidentType = ConversionIncidentType.Informative;

                foreach (var conversionIncident in _conversionIncidentsByLineNumber[incidentLineNumber])
                {
                    if (sb.Length > 0)
                    {
                        sb.Append("\n\r");
                    }
                    sb.Append(conversionIncident.Title);
                    sb.Append(" [");
                    sb.Append(conversionIncident.Description);
                    sb.Append("]");

                    if (conversionIncident.IncidentType == ConversionIncidentType.ManualActionRequired)
                    {
                        highestIncidentType = ConversionIncidentType.ManualActionRequired;
                    }
                }

                conversionIncidentInfo = string.Format((highestIncidentType == ConversionIncidentType.ManualActionRequired)
                    ? HtmlErrorImageTagFormat
                    : HtmlAlertImageTagFormat, sb.ToString());
            }

            return conversionIncidentInfo;
        }

        protected string BuildConversionIncidentLinkTag(int incidentLineNumber)
        {
            ConversionIncidentType highestIncidentType;
            return string.Format("<a href=\"./{0}#line_{1}\" target=\"_blank\">{2}</a>", Path.GetFileName(VendorHtmlFile), incidentLineNumber, BuildConversionIncidentInfo(incidentLineNumber, out highestIncidentType));
        }

        protected string RuleItemsList2Html(List<CheckPointObject> ruleItems, bool isCellNegated, string defaultValue, ref ConversionIncidentType ruleConversionIncidentType)
        {
            if (ruleItems.Count == 0)
            {
                return defaultValue;
            }

            string res = "";

            if (isCellNegated)
            {
                res += "<div style='text-align: center';>";
                res += "<div style='color: white; background-color: #6e0c0c; font-style: italic; padding-left: 2px; padding-right: 2px; border-radius: 3px; display: inline-block;'>Negated</div>";
                res += "</div>";
            }

            foreach (CheckPointObject item in ruleItems)
            {
                if (_cpObjects.IsKnownService(item.Name))
                {
                    res += "<div>" + item.Name + "</div>";
                }
                else
                {
                    if (item.ConversionIncidentType != ConversionIncidentType.None)
                    {
                        if (item.ConversionIncidentType > ruleConversionIncidentType)   // Error type overrides information type!!!
                        {
                            ruleConversionIncidentType = item.ConversionIncidentType;
                        }
                        res += "<div>" + BuildConversionIncidentLinkTag(item.ConvertedCommandId) + "<a href='./" + Path.GetFileName(ObjectsHtmlFile) + "#" + item.Name + "' target='_blank'>" + item.Name + "</a></div>";
                    }
                    else
                    {
                        res += "<div><a href='./" + Path.GetFileName(ObjectsHtmlFile) + "#" + item.Name + "' target='_blank'>" + item.Name + "</a></div>";
                    }
                }
            }

            return res;
        }

        protected string RuleStringList2Html(List<string> ruleString, bool isCellNegated, string defaultValue, ref ConversionIncidentType ruleConversionIncidentType)
        {
            if (ruleString.Count == 0)
            {
                return defaultValue;
            }

            string res = "";

            if (isCellNegated)
            {
                res += "<div style='text-align: center';>";
                res += "<div style='color: white; background-color: #6e0c0c; font-style: italic; padding-left: 2px; padding-right: 2px; border-radius: 3px; display: inline-block;'>Negated</div>";
                res += "</div>";
            }

            foreach (string item in ruleString)
            {
                if (_cpObjects.IsKnownService(item))
                {
                    res += "<div>" + item + "</div>";
                }
                else
                {

                    res += "<div><a href='./" + Path.GetFileName(ObjectsHtmlFile) + "#" + item + "' target='_blank'>" + item + "</a></div>";

                }
            }

            return res;
        }

        protected string NatRuleItem2Html(string itemName)
        {
            return string.Format("<div><a href='./{0}#{1}' target='_blank'>{1}</a></div>", Path.GetFileName(ObjectsHtmlFile), itemName);
        }

        protected string GeneratePackageHtmlReportDateTime()
        {
            var currentDate = DateTime.Now.ToLocalTime();
            var dtfi = new DateTimeFormatInfo { DateSeparator = "." };
            var currentDateString = currentDate.ToString("d", dtfi);
            var currentTimeString = currentDate.ToString("HH:mm", dtfi);
            var policyHtmlReportDateTime = currentDateString + " \\ " + currentTimeString;

            return policyHtmlReportDateTime;
        }

        protected void GeneratePackageHtmlReportHeaders(StreamWriter reportFile, string packageName, bool hasConversionIncidents)
        {
            reportFile.WriteLine("<html>");
            reportFile.WriteLine("<head>");
            reportFile.WriteLine("<style>");
            reportFile.WriteLine("  body { font-family: Helvetica; margin-left: 0px; margin-right: 0px; margin-top: 0px; }");
            reportFile.WriteLine("  table { border-collapse: collapse; border: 1px solid gray; margin: 20px; }");
            reportFile.WriteLine("  td { vertical-align: text-top; padding: 6px; border: 1px solid gray; }");
            reportFile.WriteLine("  th { vertical-align: text-top; padding: 6px; border: 1px solid gray; background-color: rgb(87,99,114); font-weight: bold; color: white; }");
            reportFile.WriteLine("  .report_time { font-family: Segoe UI; font-size: 14px; font-weight: normal; border-left: 1px solid #c9c9c9; padding: 10px; } ");
            reportFile.WriteLine("  .rule_number { background-color: rgb(245,245,245); text-align: left; } ");
            reportFile.WriteLine("  .indent_rule_number { border: 0px; min-width: 10px; }");
            reportFile.WriteLine("  .parent_rule { font-weight: bold; }");
            reportFile.WriteLine("  .parent_rule_disabled { font-weight: bold; text-decoration: line-through; }");
            reportFile.WriteLine("  .disabled_rule { text-decoration: line-through; } ");
            reportFile.WriteLine("  .errors_header { background-color: rgb(213,51,30); } ");
            reportFile.WriteLine("  .accept { color: green; }");
            reportFile.WriteLine("  .drop { color: red; }");
            reportFile.WriteLine("  .reject { color: red; }");
            reportFile.WriteLine("  .comments { font-family: Lucida Console; }");
            reportFile.WriteLine("</style>");
            reportFile.WriteLine("<script>");
            reportFile.WriteLine("   var errorsCounter = 0;");
            reportFile.WriteLine("   var infosCounter = 0;");
            reportFile.WriteLine("   function displayIncidentsCount() {");
            reportFile.WriteLine("      if (errorsCounter > 0) {");
            reportFile.WriteLine("         var elem1 = document.getElementById('errorsCountHost');");
            reportFile.WriteLine("         if (elem1 != null) {");
            reportFile.WriteLine("            elem1.style.display = 'inline';");
            reportFile.WriteLine("         }");
            reportFile.WriteLine("         var elem2 = document.getElementById('errorsCount');");
            reportFile.WriteLine("         if (elem2 != null) {");
            reportFile.WriteLine("            elem2.innerText = elem2.innerText + errorsCounter;");
            reportFile.WriteLine("         }");
            reportFile.WriteLine("      }");
            reportFile.WriteLine("      if (infosCounter > 0) {");
            reportFile.WriteLine("         var elem1 = document.getElementById('infosCountHost');");
            reportFile.WriteLine("         if (elem1 != null) {");
            reportFile.WriteLine("            elem1.style.display = 'inline';");
            reportFile.WriteLine("         }");
            reportFile.WriteLine("         var elem2 = document.getElementById('infosCount');");
            reportFile.WriteLine("         if (elem2 != null) {");
            reportFile.WriteLine("            elem2.innerText = elem2.innerText + infosCounter;");
            reportFile.WriteLine("         }");
            reportFile.WriteLine("      }");
            reportFile.WriteLine("   }");
            reportFile.WriteLine("   var right_icon = \"" + HtmlRightArrowImageSourceData + "\";");
            reportFile.WriteLine("   var down_icon = \"" + HtmlDownArrowImageSourceData + "\";");
            reportFile.WriteLine("   function toggleSubRules(e) {");
            reportFile.WriteLine("      var parrent_rule = e.parentNode.id;");
            reportFile.WriteLine("      // update the arrow image");
            reportFile.WriteLine("      var img = document.getElementById(parrent_rule + '_img');");
            reportFile.WriteLine("      current_icon = img.getAttribute('src');");
            reportFile.WriteLine("      if (current_icon == right_icon) {");
            reportFile.WriteLine("         img.setAttribute('src', down_icon);");
            reportFile.WriteLine("      }");
            reportFile.WriteLine("      else {");
            reportFile.WriteLine("         img.setAttribute('src', right_icon);");
            reportFile.WriteLine("      }");
            reportFile.WriteLine("      // toggle the visibility of sub-rules");
            reportFile.WriteLine("      var i=1;");
            reportFile.WriteLine("      while (document.getElementById(parrent_rule + '.' + i)) {");
            reportFile.WriteLine("         var sub_rule = document.getElementById(parrent_rule + '.' + i);");
            reportFile.WriteLine("         sub_rule.style.display = sub_rule.style.display == 'none' ? 'table-row' : 'none';");
            reportFile.WriteLine("         var j=1;");
            reportFile.WriteLine("         while (document.getElementById(parrent_rule + '.' + i + '.' + j)) {");
            reportFile.WriteLine("            var sub_sub_rule = document.getElementById(parrent_rule + '.' + i + '.' + j);");
            reportFile.WriteLine("              // check arrow image to know whether to show sub-sub rules");
            reportFile.WriteLine("              var sub_img = document.getElementById(parrent_rule + '.' + i + '_img');");
            reportFile.WriteLine("              sub_current_icon = sub_img.getAttribute('src');");
            reportFile.WriteLine("              if (sub_current_icon == right_icon) {");
            reportFile.WriteLine("                  sub_sub_rule.style.display = 'none'");
            reportFile.WriteLine("              }");
            reportFile.WriteLine("              else {");
            reportFile.WriteLine("                  sub_sub_rule.style.display = sub_rule.style.display == 'none' ? 'none' : 'table-row';");
            reportFile.WriteLine("              }");
            reportFile.WriteLine("         j++;");
            reportFile.WriteLine("         }");
            reportFile.WriteLine("      i++;");
            reportFile.WriteLine("      }");
            reportFile.WriteLine("   }");
            reportFile.WriteLine("</script>");
            reportFile.WriteLine("</head>");
            reportFile.WriteLine("<body onLoad='displayIncidentsCount()'>");

            // Generate the report header
            reportFile.WriteLine("<div style='height: 70px; line-height: 70px; background-color: black; padding-left: 20px; margin-bottom: 35px; color: white; font-family: Segoe UI; font-size: 20px;'>");
            reportFile.WriteLine("   <img style='width: 33px; height: 32px; padding-top: 20;' " + HtmlToolLogoImageSource + "/>");
            reportFile.WriteLine("   <span style='font-weight: bold; vertical-align: top;'>SmartMove</span>");
            reportFile.WriteLine("   <span style='font-size: 10px; position: absolute; padding-top: 4px; margin-left: 10px;'>ver " + _toolVersion + "</span>");
            reportFile.WriteLine("   <img style='width: 118px; height: 20px; position: absolute; right: 20; padding-top: 25;' " + HtmlCPLogoImageSource + "/>");
            reportFile.WriteLine("</div>");
            reportFile.WriteLine("<div style='font-size: 30px; font-weight: lighter; margin-left: 20px; margin-bottom: 30px;'>CONVERSION REPORT  ");
            reportFile.WriteLine("   <span id='reportTime' class='report_time'>" + GeneratePackageHtmlReportDateTime() + "</span>");
            reportFile.WriteLine("</div>");
            reportFile.WriteLine("<div style='font-size: 16px; margin-left: 20px; margin-bottom: 15px;'>");
            reportFile.WriteLine("   <span style='font-weight: normal;'>Policy Package: </span><span style='font-weight: bold;'>" + packageName + "</span>");
            reportFile.WriteLine("</div>");

            if (hasConversionIncidents)
            {
                reportFile.WriteLine("<div style='margin-left: 20px;'>");
                reportFile.WriteLine("   <span style='font-weight: bold;'>Found Conversion Issues:</span>");
                reportFile.WriteLine("   <span id='errorsCountHost' style='display: none; margin-left: 10px; vertical-align: middle;'>" + string.Format(HtmlErrorImageTagFormat, "Conversion Errors"));
                reportFile.WriteLine("      <a id='errorsCount' href='#PolicyConversionErrors' style='margin-left: 2px; vertical-align: top;'></a>");
                reportFile.WriteLine("   </span>");
                reportFile.WriteLine("   <span id='infosCountHost' style='display: none; margin-left: 10px; vertical-align: middle;'>" + string.Format(HtmlAlertImageTagFormat, "Conversion Notifications"));
                reportFile.WriteLine("      <a id='infosCount' href='#PolicyConversionInfos' style='margin-left: 2px; vertical-align: top;'/></a>");
                reportFile.WriteLine("   </span>");
                reportFile.WriteLine("</div>");
            }
        }

        #endregion
        /*
        * This method generates cp_objects.json file containing CheckPoint objects.
        * Further it creates archive containing cp_objects.json file and SmartConnector.py script.
        */
        public void CreateSmartConnector()
        {
            const string dirLibName = "cpapi";

            string[] pySmartConnectorFNs = new string[] {
                    dirLibName + Path.DirectorySeparatorChar + "__init__.py",
                    dirLibName + Path.DirectorySeparatorChar + "api_exceptions.py",
                    dirLibName + Path.DirectorySeparatorChar + "api_response.py",
                    dirLibName + Path.DirectorySeparatorChar + "mgmt_api.py",
                    dirLibName + Path.DirectorySeparatorChar + "utils.py",
                    "smartconnector.py"
                };

            bool isGeneratingSC = true;
            foreach (var pySmartConnectorFN in pySmartConnectorFNs)
            {
                if (!File.Exists(Directory.GetCurrentDirectory() + Path.DirectorySeparatorChar + "SmartConnector" + Path.DirectorySeparatorChar + pySmartConnectorFN))
                {
                    isGeneratingSC = false;
                    break;
                }
            }

            string compressorsDirPath = Directory.GetCurrentDirectory() + Path.DirectorySeparatorChar + "compressors";
            string compressorZip = Path.Combine(compressorsDirPath, "zip.exe");
            string compressorGtar = Path.Combine(compressorsDirPath, "gtar.exe");
            string compressorGzip = Path.Combine(compressorsDirPath, "gzip.exe");
            if (!File.Exists(compressorZip) || !File.Exists(compressorGtar) || !File.Exists(compressorGzip))
                isGeneratingSC = false;

            if (isGeneratingSC)
            {
                RaiseConversionProgress(90, "Generating Smart Connector ...");
                string cpObjectsJsonFN = "cp_objects.json";
                string cpObjectsJsonFP = _targetFolder + Path.DirectorySeparatorChar + cpObjectsJsonFN;

                #region adding objects and rules to list for generating JSON

                List<CheckPointObject> cpJsonObjects = new List<CheckPointObject>();
                cpJsonObjects.AddRange(_cpDomains);
                cpJsonObjects.AddRange(_cpHosts);
                cpJsonObjects.AddRange(_cpNetworks);
                cpJsonObjects.AddRange(_cpRanges);
                // adding NetworkGroups and NetworkGroups with Exclusions
                CheckPoint_NetworkGroup allInternal = null;
                bool splitNetworkGroupsCreation = (_cpNetworkGroups.Count > 0 && _cpGroupsWithExclusion.Count > 0);
                if (_cpNetworkGroups.Count > 0)
                {
                    foreach (CheckPoint_NetworkGroup obj in _cpNetworkGroups)
                    {
                        if (obj.Name == AllInternalNetwotkGroupName)
                        {
                            allInternal = obj;
                            continue;
                        }
                        if (splitNetworkGroupsCreation && obj.CreateAfterGroupsWithExclusion)
                        {
                            continue;
                        }

                        cpJsonObjects.Add(obj);
                    }
                }
                if (_cpGroupsWithExclusion.Count > 0)
                {
                    foreach (CheckPoint_GroupWithExclusion obj in _cpGroupsWithExclusion)
                    {
                        cpJsonObjects.Add(obj);
                    }
                }
                if (splitNetworkGroupsCreation)
                {
                    foreach (CheckPoint_NetworkGroup obj in _cpNetworkGroups)
                    {
                        if (!obj.CreateAfterGroupsWithExclusion)
                        {
                            continue;
                        }
                        cpJsonObjects.Add(obj);
                    }
                }
                if (allInternal != null)
                {
                    cpJsonObjects.Add(allInternal);
                }
                // NetworkGroups and NetworkGroups with Exclusion are added
                cpJsonObjects.Add(_cpSimpleGateway);
                cpJsonObjects.AddRange(_cpZones);
                cpJsonObjects.AddRange(_cpTcpServices);
                cpJsonObjects.AddRange(_cpUdpServices);
                cpJsonObjects.AddRange(_cpOtherServices);
                cpJsonObjects.AddRange(_cpServiceGroups);
                cpJsonObjects.AddRange(_cpTimeGroups);
                cpJsonObjects.AddRange(_cpTimes);
                // objects are added
                // adding Security rules
                cpJsonObjects.Add(_cpPackages.FirstOrDefault());
                // adding NAT rules
                _cpNatRules.ForEach(x => x.Package = _cpPackages[0].Name);
                cpJsonObjects.AddRange(_cpNatRules);

                //remove all NULL elements
                cpJsonObjects.RemoveAll(x => x == null);
                #endregion

                File.WriteAllText(cpObjectsJsonFP, JsonConvert.SerializeObject(cpJsonObjects, Formatting.Indented));

                string smartConnectorArchiveName = "smartconnector_" + _vendorFileName;
                string smartConnectorArchivePath = _targetFolder + Path.DirectorySeparatorChar + smartConnectorArchiveName;

                #region preparing smarctconnector to archiving
                if (Directory.Exists(smartConnectorArchivePath))
                    Directory.Delete(smartConnectorArchivePath, true);

                Directory.CreateDirectory(smartConnectorArchivePath);
                foreach (var pySmartConnectorFN in pySmartConnectorFNs)
                {
                    Directory.CreateDirectory(Directory.GetParent(smartConnectorArchivePath + Path.DirectorySeparatorChar + pySmartConnectorFN).FullName);
                    File.Copy(Directory.GetCurrentDirectory() + Path.DirectorySeparatorChar + "SmartConnector" + Path.DirectorySeparatorChar + pySmartConnectorFN,
                                smartConnectorArchivePath + Path.DirectorySeparatorChar + pySmartConnectorFN);
                }
                if (!string.IsNullOrWhiteSpace(this._domainName)) // update by Domain
                {
                    Encoding utf8Enc = new UTF8Encoding(false);
                    string smartConnectorSFP = smartConnectorArchivePath + Path.DirectorySeparatorChar + "smartconnector.py";
                    string smartConnectorFC = File.ReadAllText(smartConnectorSFP, utf8Enc);
                    smartConnectorFC = smartConnectorFC.Replace(
                                            "parser.add_argument('-d', '--domain', default=None,",
                                            "parser.add_argument('-d', '--domain', default='" + this._domainName + "',");
                    File.WriteAllText(smartConnectorSFP, smartConnectorFC, utf8Enc);
                }
                File.Copy(cpObjectsJsonFP, smartConnectorArchivePath + Path.DirectorySeparatorChar + cpObjectsJsonFN);
                #endregion

                ProcessStartInfo startInfo = new ProcessStartInfo();
                startInfo.UseShellExecute = false;
                startInfo.CreateNoWindow = true;
                Process compressProc = null;

                #region createing ZIP archive
                if (File.Exists(smartConnectorArchivePath + ".zip"))
                    File.Delete(smartConnectorArchivePath + ".zip");

                startInfo.FileName = compressorZip;
                startInfo.WorkingDirectory = _targetFolder + Path.DirectorySeparatorChar + smartConnectorArchiveName;
                startInfo.Arguments = "-r" + " ..\\" + smartConnectorArchiveName + ".zip" + " *";
                compressProc = Process.Start(startInfo);
                compressProc.WaitForExit();
                #endregion

                #region createing TAR.GZ archive
                if (File.Exists(smartConnectorArchivePath + ".tar.gz"))
                    File.Delete(smartConnectorArchivePath + ".tar.gz");

                startInfo.FileName = compressorGtar;
                startInfo.WorkingDirectory = _targetFolder + Path.DirectorySeparatorChar + smartConnectorArchiveName;
                startInfo.Arguments = "cf" + " ..\\" + smartConnectorArchiveName + ".tar" + " *";
                compressProc = Process.Start(startInfo);
                compressProc.WaitForExit();

                startInfo.FileName = compressorGzip;
                startInfo.WorkingDirectory = _targetFolder;
                startInfo.Arguments = smartConnectorArchiveName + ".tar";
                compressProc = Process.Start(startInfo);
                compressProc.WaitForExit();
                #endregion

                if (File.Exists(cpObjectsJsonFP))
                    File.Delete(cpObjectsJsonFP);

                if (Directory.Exists(smartConnectorArchivePath))
                    Directory.Delete(smartConnectorArchivePath, true);
            }
        }
    }
}
